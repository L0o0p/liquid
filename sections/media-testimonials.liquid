{%- style -%}
   .media-testimonials {
    padding: clamp(40px, 5vw, 80px) clamp(20px, 8vw, 160px);
    background-color: #D5E7B3;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    position:relative;
    height: 700px;
  }

  .media-lace{
    position:absolute;
    z-index:50;
    bottom:-2px;
     width: 100%;
  }

  .media-lace svg{
    display:block;
    width: 100%;
    height: auto; /* 让高度根据宽度自动调整 */
  }

  .page-width {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
  }

  .media-testimonials__heading {
  font-family: 'DMSerifDisplay-Regular';
    font-size: clamp(22px, 4vw, 28px);
    color:#12A89D;
    margin-bottom: clamp(20px, 4vw, 40px);
    font-weight: 700;
  }

  .media-testimonials__quote {
    font-size: clamp(16px, 3vw, 24px);
    line-height: 1.6;
    max-width: 1280px;
    margin: 0 auto clamp(30px, 5vw, 50px);
    font-weight: 300;
    width: 100%;
    color:black;
  }

  .media-testimonials__logos-container {
    position: relative;
    width: 100%;
    margin: 0 auto;
    max-width: 1280px;
  }

  .media-testimonials__logos {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    width: 100%;
    overflow: hidden;
    position: relative;
    height: clamp(50px, 10vw, 72px);
  }

  .media-testimonials__logos-wrapper {
    display: flex;
    align-items: center;
    transition: transform 0.5s ease;
    touch-action: pan-x;
    width: 100%;
  }

  .media-testimonials__logo {
    height: clamp(30px, 8vw, 60px);
    flex: 0 0 25%; /* Important: Each logo takes exactly 25% of the width */
    opacity: {{ section.settings.inactive_logo_opacity }};
    transition: opacity 0.3s ease, transform 0.3s ease;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0 10px;
    box-sizing: border-box;
  }

  .media-testimonials__logo img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }

  .media-testimonials__logo.active {
    opacity: 1;
    transform: scale(1.05);
  }

  .media-testimonials__slides {
    position: relative;
    overflow: hidden;
    min-height: clamp(80px, 20vw, 120px);
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
    color:white
  }

  .media-testimonials__slide {
    position: absolute;
    width: 100%;
    opacity: 0;
    transition: opacity 0.5s ease;
    pointer-events: none;
  }

  .media-testimonials__slide.active {
    opacity: 1;
    position: relative;
    pointer-events: auto;
  }

  /* 平板设备 */
  @media screen and (max-width: 1280px) {
    .media-testimonials__quote,
    .media-testimonials__slides,
    .media-testimonials__logos-container {
      max-width: 90%;
    }
  }

  @media screen and (max-width: 1080px) {
    .media-testimonials {
      padding: 60px 40px;
      height:640px
    }
  }

  /* 小平板设备 */
  @media screen and (max-width: 768px) {
    .media-testimonials {
      padding: 40px 20px;
    }

    .media-testimonials__logos {
      height: 60px;
    }

    .media-testimonials__logo {
      flex: 0 0 25%; /* Show 2 logos on tablets */
    }

    .media-testimonials__quote {
      padding: 0 10px;
      font-size: 20px !important;
    }
  }

  /* 手机设备 */
  @media screen and (max-width: 480px) {
    .media-testimonials {
      padding: 30px 15px;
    }

    .media-testimonials__heading {
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 700;
    }

    .media-testimonials__logos {
      height: 50px;
    }

    .media-testimonials__logo {
      height: 25px;
    }

    .media-testimonials__quote {
      margin-bottom: 25px;
      font-size: 16px !important;
      font-weight: 300;
    }

    .media-testimonials__quote, .media-testimonials__slides, .media-testimonials__logos-container {
      max-width: 100%;
      margin-bottom: 16px;
    }
  }
{%- endstyle -%}

<div class="media-testimonials" id="media-testimonials-{{ section.id }}">
  <div class="media-lace">
    {% render 'media-lace' %}
  </div>
  <div class="page-width">
    <h2 class="media-testimonials__heading">
      {{ section.settings.heading | default: 'What the Globe is Saying' }}
    </h2>

    <div class="media-testimonials__slides">
      {% for block in section.blocks %}
        <div
          class="media-testimonials__slide{% if forloop.first %} active{% endif %}"
          data-index="{{ forloop.index0 }}"
        >
          <p class="media-testimonials__quote">"{{ block.settings.quote }}"</p>
        </div>
      {% endfor %}

      <!-- Add placeholder testimonials to match expanded logo list -->
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size }}">
        <p class="media-testimonials__quote">
          "This ergonomic chair delivers exceptional comfort and support during long working hours. The adjustable
          features make it easy to find your perfect position."
        </p>
      </div>
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size | plus: 1 }}">
        <p class="media-testimonials__quote">
          "We've tested dozens of office chairs, and OdinLake stands out with its innovative design and premium quality
          materials. A top contender in the ergonomic chair market."
        </p>
      </div>
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size | plus: 2 }}">
        <p class="media-testimonials__quote">
          "If you're looking for a chair that balances aesthetics with ergonomics, look no further. OdinLake delivers a
          product that's as stylish as it is comfortable."
        </p>
      </div>
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size | plus: 3 }}">
        <p class="media-testimonials__quote">
          "The lumbar support and adjustable headrest on this chair are game-changers for anyone who suffers from back
          pain after long hours at a desk."
        </p>
      </div>
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size | plus: 4 }}">
        <p class="media-testimonials__quote">
          "OdinLake has created a masterpiece of ergonomic design with their latest chair model. The attention to detail
          and quality construction is evident in every aspect."
        </p>
      </div>
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size | plus: 5 }}">
        <p class="media-testimonials__quote">
          "Our office equipped all workstations with OdinLake chairs, and employee satisfaction scores increased by 27%.
          The investment in quality ergonomic seating has truly paid off."
        </p>
      </div>
      <div class="media-testimonials__slide" data-index="{{ section.blocks.size | plus: 6 }}">
        <p class="media-testimonials__quote">
          "After reviewing over 50 ergonomic chairs, OdinLake consistently ranks at the top for comfort, durability, and
          adjustability. A worthwhile investment for your home office."
        </p>
      </div>
    </div>

    <div class="media-testimonials__logos-container">
      <div class="media-testimonials__logos">
        <div class="media-testimonials__logos-wrapper">
          <!-- Original logos from section blocks -->
          {% for block in section.blocks %}
            <div
              class="media-testimonials__logo{% if forloop.first %} active{% endif %}"
              data-index="{{ forloop.index0 }}"
            >
              {% if block.settings.logo != blank %}
                <img
                  src="{{ block.settings.logo | image_url: width: 200 }}"
                  alt="{{ block.settings.logo_name }}"
                  loading="lazy"
                  width="auto"
                  height="60"
                >
              {% elsif block.settings.logo_url != blank %}
                <img
                  src="{{ block.settings.logo_url }}"
                  alt="{{ block.settings.logo_name }}"
                  loading="lazy"
                  width="auto"
                  height="60"
                >
              {% elsif block.settings.logo_asset != blank %}
                <img
                  src="{{ block.settings.logo_asset | asset_url }}"
                  alt="{{ block.settings.logo_name }}"
                  loading="lazy"
                  width="auto"
                  height="60"
                >
              {% else %}
                <!-- Fallback if no logo is set in the block -->
                <img
                  src="https://via.placeholder.com/180x60?text=Logo {{ forloop.index }}"
                  alt="Media Logo {{ forloop.index }}"
                  loading="lazy"
                  width="auto"
                  height="60"
                >
              {% endif %}
            </div>
          {% endfor %}

          <!-- Additional placeholder logos -->
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size }}">
            <img
              src="{{ 'com_1.png' | asset_url }}"
              alt="Forbes"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size | plus: 1 }}">
            <img
              src="{{ 'com_2.png' | asset_url }}"
              alt="TechRadar"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size | plus: 2 }}">
            <img
              src="{{ 'com_3.png' | asset_url }}"
              alt="Wired"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size | plus: 3 }}">
            <img
              src="{{ 'com_4.png' | asset_url }}"
              alt="CNN"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size | plus: 4 }}">
            <img
              src="{{ 'com_5.png' | asset_url }}"
              alt="Bloomberg"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size | plus: 5 }}">
            <img
              src="{{ 'com_1.png' | asset_url }}"
              alt="Fast Company"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
          <div class="media-testimonials__logo" data-index="{{ section.blocks.size | plus: 6 }}">
            <img
              src="{{ 'com_1.png' | asset_url }}"
              alt="Wall Street Journal"
              loading="lazy"
              width="auto"
              height="60"
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const testimonialContainer = document.getElementById('media-testimonials-{{ section.id }}');
    const slides = testimonialContainer.querySelectorAll('.media-testimonials__slide');
    const logos = testimonialContainer.querySelectorAll('.media-testimonials__logo');
    const logosWrapper = testimonialContainer.querySelector('.media-testimonials__logos-wrapper');
    const logosContainer = testimonialContainer.querySelector('.media-testimonials__logos');
    
    // Constants
    const DESKTOP_ITEMS_PER_VIEW = 4; // Always show 4 logos on desktop
    const TABLET_ITEMS_PER_VIEW = 2;  // Show 2 logos on tablets
    const logoCount = logos.length;
    
    // State variables
    let currentSlideIndex = 0;
    let currentGroupIndex = 0;
    let startX = 0;
    let isDragging = false;
    let autoplayInterval;
    
    // Get current items per view based on screen size
    function getItemsPerView() {
      return window.innerWidth <= 768 ? TABLET_ITEMS_PER_VIEW : DESKTOP_ITEMS_PER_VIEW;
    }
    
    // This function shows a specific testimonial
    function showTestimonial(index) {
      // Normalize the index
      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;
      
      // Update active state for slides
      slides.forEach(slide => slide.classList.remove('active'));
      slides[index].classList.add('active');
      
      // Update active logo indicator
      logos.forEach(logo => logo.classList.remove('active'));
      logos[index].classList.add('active');
      
      // Make sure the active logo is visible
      const itemsPerView = getItemsPerView();
      const groupIndex = Math.floor(index / itemsPerView);
      goToGroup(groupIndex);
      
      currentSlideIndex = index;
    }
    
    // This function shifts to a specific group of logos
    function goToGroup(groupIndex) {
      const itemsPerView = getItemsPerView();
      const totalGroups = Math.ceil(logoCount / itemsPerView);
      
      // Normalize group index
      if (groupIndex < 0) groupIndex = totalGroups - 1;
      if (groupIndex >= totalGroups) groupIndex = 0;
      
      // Calculate the percentage to translate
      const translatePercentage = -(groupIndex * 100) + '%';
      logosWrapper.style.transform = `translateX(${translatePercentage})`;
      
      currentGroupIndex = groupIndex;
    }
    
    // Setup logo click handlers
    logos.forEach(logo => {
      logo.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        showTestimonial(index);
        resetAutoplay();
      });
    });
    
    // Setup touch/mouse drag functionality
    logosContainer.addEventListener('mousedown', startDrag);
    logosContainer.addEventListener('touchstart', startDrag, { passive: true });
    
    window.addEventListener('mousemove', drag);
    window.addEventListener('touchmove', drag, { passive: false });
    
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
    
    function startDrag(e) {
      isDragging = true;
      startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      
      // Disable transition during drag for immediate response
      logosWrapper.style.transition = 'none';
      
      // Clear autoplay during interaction
      clearInterval(autoplayInterval);
    }
    
    function drag(e) {
      if (!isDragging) return;
      
      // Prevent default during drag to stop page scrolling
      if (e.cancelable && Math.abs(e.type.includes('mouse') ? e.pageX - startX : e.touches[0].pageX - startX) > 5) {
        e.preventDefault();
      }
      
      const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      const diff = currentX - startX;
      
      // Get current transform value
      const transform = window.getComputedStyle(logosWrapper).getPropertyValue('transform');
      const matrix = new DOMMatrix(transform);
      const currentTranslate = matrix.m41;
      
      // Apply the drag offset
      logosWrapper.style.transform = `translateX(${currentTranslate + diff}px)`;
      
      // Update starting position for next drag calculation
      startX = currentX;
    }
    
    function endDrag() {
      if (!isDragging) return;
      isDragging = false;
      
      // Restore transition
      logosWrapper.style.transition = 'transform 0.5s ease';
      
      // Calculate the nearest group
      const itemsPerView = getItemsPerView();
      const containerWidth = logosContainer.offsetWidth;
      const groupWidth = containerWidth;
      
      // Get current transform value
      const transform = window.getComputedStyle(logosWrapper).getPropertyValue('transform');
      const matrix = new DOMMatrix(transform);
      const currentTranslate = matrix.m41;
      
      // Calculate the target group index
      const targetGroupIndex = Math.round(-currentTranslate / groupWidth);
      const totalGroups = Math.ceil(logoCount / itemsPerView);
      
      // Clamp to valid range
      const clampedGroupIndex = Math.max(0, Math.min(totalGroups - 1, targetGroupIndex));
      
      // Go to the nearest group
      goToGroup(clampedGroupIndex);
      
      // Restart autoplay
      resetAutoplay();
    }
    
    // Handle responsive changes
    window.addEventListener('resize', function() {
      // When screen size changes, we need to recalculate the current group
      // to ensure we're still showing the correct set of logos
      const itemsPerView = getItemsPerView();
      const groupIndex = Math.floor(currentSlideIndex / itemsPerView);
      goToGroup(groupIndex);
    });
    
    // Initialize autoplay if enabled
    function startAutoplay() {
      {% if section.settings.autoplay %}
        autoplayInterval = setInterval(function() {
          // Advance to next slide
          showTestimonial(currentSlideIndex + 1);
        }, {{ section.settings.autoplay_speed | times: 1000 }});
      {% endif %}
    }
    
    function resetAutoplay() {
      clearInterval(autoplayInterval);
      startAutoplay();
    }
    
    // Start with first testimonial and autoplay
    showTestimonial(0);
    startAutoplay();
    
    // Pause autoplay on hover if enabled
    {% if section.settings.autoplay %}
      testimonialContainer.addEventListener('mouseenter', function() {
        clearInterval(autoplayInterval);
      });
      
      testimonialContainer.addEventListener('mouseleave', function() {
        startAutoplay();
      });
    {% endif %}
  });
</script>
{% schema %}
{
  "name": "Media Testimonials",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What the Globe is Saying"
    },
    {
      "type": "range",
      "id": "inactive_logo_opacity",
      "label": "Inactive Logo Opacity",
      "min": 0.1,
      "max": 1,
      "step": 0.1,
      "default": 0.5
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-rotate testimonials",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Change slides every x seconds",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "logo",
          "label": "Logo Image"
        },
        {
          "type": "text",
          "id": "logo_url",
          "label": "Logo URL (optional)",
          "info": "Use instead of image upload if needed"
        },
        {
          "type": "text",
          "id": "logo_asset",
          "label": "Logo Asset (optional)",
          "info": "File name in assets folder (e.g. 'logo.png')"
        },
        {
          "type": "text",
          "id": "logo_name",
          "label": "Logo Name",
          "default": "Media Name"
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "This ergonomic chair delivers exceptional comfort and support during long working hours."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Media Testimonials",
      "blocks": [
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        }
      ]
    }
  ]
}
{% endschema %}
